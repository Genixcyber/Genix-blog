---
title: CVE-2018-6791 | Arbitrary Command Execution in KDE
layout: post
date: 2018-02-18 08:30:00 +0000
image: images/kde.png

---
<h1 class="cyan-text title">CVE-2018-6791 | PoC | Arbitrary Command Execution in KDE Plasma</h1>
<img class="responsive-img z-depth-5" src="{{ site-url }}/images/kde.png">
<h2 class="cyan-text subtitle">Introduction</h2>
<div class="content white-text">
An issue was discovered in KDE Plasma Workspace before 5.12.0. When a vfat thumb drive that contains \`\` or $() in its volume label is plugged in and mounted through the device notifier, it's interpreted as a shell command, leading to a possibility of arbitrary command execution. An example of an offending volume label is "$(touch b)" -- this will create a file called b in the home folder. <br>
<h3 class="cyan-text subtitle">Lab Setup</h3>
<b class="cyan-text">Target OS :</b> Linux Mint 18.3 running KDE Plasma 5.8
<br>
<b class="cyan-text">Attacker Machine :</b> Kali Linux 2018.1
<br>
<h4 class="cyan-text subtitle">Vulnerability</h4>
The vulnerability exists in soliduiserver/deviceserviceaction.cpp in KDE Plasma Workspace before 5.12.0. When a vfat thumb drive that contains \`\` or $() in its volume label is plugged in and mounted through the device notifier, it's interpreted as a shell command, leading to a possibility of arbitrary command execution. <br> Letâ€™s take a look at soliduiserver/deviceserviceaction.cpp
<br>
This is the original unpatched code in soliduiserver/deviceserviceaction.cpp
<pre><code class="black green-text">void DelayedExecutor::delayedExecute(const QString &udi) {
Solid::Device device(udi);
QString exec = m_service.exec();
MacroExpander mx(device);
mx.expandMacros(exec);
KRun::runCommand(exec, QString(), m_service.icon(), 0);
deleteLater(); }
</code></pre>
<br>
Here the code originally contains
<pre><code class="black green-text"> mx.expandMacros(exec);
</code></pre>
This function allows arbitrary command execution and to patch this KDE replaced this line with
<pre><code class="black green-text">mx.expandMacrosShellQuote(exec);
</code></pre>
Originally the device label is not quoted and is interpreted as a shell command, ShellQuote makes the device label quoted.
<br>
<h5 class="cyan-text subtitle">What is FAT</h5>
FAT is an acronym for File Allocation Table, Introduced in 1981. Because of its age, most operating systems, including Microsoft Windows NT, Windows 98, the Macintosh OS, and some versions of UNIX, offer support for FAT. The FAT file system limits to eight character. Filenames in a FAT file system must  begin with a letter or number, and they can't contain spaces. Filenames aren't case sensitive.
<br>
<h6 class="cyan-text subtitle">What is VFAT</h6>
VFAT is an extension of the FAT file system and was introduced with Windows 95. VFAT maintains backward compatibility with FAT. For example, VFAT file names can contain up to 255 characters, spaces, and multiple periods. Although VFAT preserves the case of filenames, it's not considered case sensitive.
<br>
<h7 class="cyan-text subtitle">What is FAT32</h7>
<br>
FAT32 is actually an extension of FAT and VFAT, first introduced with Windows 95 OEM Service Release 2. FAT32 greatly enhances the VFAT file system. The greatest advantage to FAT32 is that it dramatically increases the amount of free hard disk space.
<br>
<h8 class="cyan-text subtitle">PoC</h8>
<br>
</div>
<div class="video-container"> <iframe width="853" height="480" src="https://www.youtube.com/embed/_rIaMoEkjFU" frameborder="0" allowfullscreen> </iframe> </div>
